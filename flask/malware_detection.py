import subprocess
from joblib import load
import pandas as pd
import os
import csv
from werkzeug.utils import secure_filename
import tempfile
from flask import Flask


app = Flask(__name__)

# Set up a temporary directory for file storage
UPLOAD_FOLDER = tempfile.mkdtemp()
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# def predict_malware(apk_file):
#     # Generate a secure filename
#     filename = secure_filename(apk_file.filename)
#
#     # Save the uploaded APK file to the temporary directory
#     apk_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
#     apk_file.save(apk_path)


def predict_malware(apk_file):
    filename = secure_filename(apk_file.filename)

    # Save the uploaded APK file to the temporary directory
    apk_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    apk_file.save(apk_path)
    # Extract permission from app and save them in a txt file
    result = subprocess.check_output(['aapt', 'dump', 'permissions', apk_path], universal_newlines=True)

    permissions = result.split('\n')[1:]
    print(permissions)

    with open('appPermissions.txt', 'w') as file:
        for permission in permissions:
            permits = permission.split('.')[-1].split(' ')[0][:-1]
            file.write(str(permits) + '\n')
        print("permissions written to txt successfully")


    with open('appPermissions.txt', 'r') as file:
        app_permissions = [line.strip() for line in file]
        print(app_permissions)

    # Read the CSV file
    with open('permission_detection_sample.csv', 'r') as infile:
        reader = csv.reader(infile)
        header = next(reader)  # Read the header
        print(header)

    permission_row = ['0'] * len(header)

    for permission in app_permissions:
        if permission in header:
            permission_row[header.index(permission)] = '1'

    print(permission_row)
    with open('permission_detection_sample.csv', 'w', newline='') as outfile:
        csv.writer(outfile).writerow(header)
        csv.writer(outfile).writerow(permission_row)

    print('CSV written successfully')

    result = []
    for filename in os.listdir('../models'):
        model_path = os.path.join('../models', filename)
        model_name = model_path.split('/')[2].split('.')[0]

        model = load(model_path)
        test_data = pd.read_csv('permission_detection_sample.csv')
        test_row = test_data.iloc[0, :]

        X_test = pd.DataFrame(test_row).transpose()
        prediction = model.predict(X_test)
        if prediction:
            prediction = 'Malware'
        else:
            prediction = 'Benign'
        result.append(f'{model_name}: \t\t\t {prediction}')
    return result

# print(predict_malware('../malware2.apk'))